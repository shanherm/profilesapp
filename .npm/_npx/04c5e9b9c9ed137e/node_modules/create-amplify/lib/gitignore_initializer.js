import { existsSync as _existsSync } from 'fs';
import _fs from 'fs/promises';
import * as path from 'path';
import * as os from 'os';
import { LogLevel, printer } from '@aws-amplify/cli-core';
/**
 * Ensure that the .gitignore file exists with the correct contents in the current working directory
 */
export class GitIgnoreInitializer {
    projectRoot;
    existsSync;
    fs;
    gitIgnorePath;
    /**
     * Injecting console and fs for testing
     */
    constructor(projectRoot, existsSync = _existsSync, fs = _fs) {
        this.projectRoot = projectRoot;
        this.existsSync = existsSync;
        this.fs = fs;
        this.gitIgnorePath = path.resolve(this.projectRoot, '.gitignore');
    }
    /**
     * If .gitignore exists, append patterns to ignore. Otherwise, create .gitignore with patterns to ignore
     */
    ensureInitialized = async () => {
        const ignorePatterns = [
            '# amplify',
            'node_modules',
            '.amplify',
            'amplify_outputs*',
            'amplifyconfiguration*',
        ];
        const gitIgnoreContent = await this.getGitIgnoreContent();
        // If .gitignore exists, append ignorePatterns that do not exist in contents
        if (gitIgnoreContent && gitIgnoreContent.length > 0) {
            const filteredIgnorePatterns = ignorePatterns.filter((pattern) => !gitIgnoreContent.includes(pattern));
            // Add os.EOL if last line of .gitignore does not have EOL
            if (gitIgnoreContent.slice(-1)[0] !== '' &&
                filteredIgnorePatterns.length > 0) {
                filteredIgnorePatterns.unshift(os.EOL);
            }
            await this.addIgnorePatterns(filteredIgnorePatterns);
            return;
        }
        printer.log('No .gitignore file found in the working directory. Creating .gitignore...', LogLevel.DEBUG);
        await this.addIgnorePatterns(ignorePatterns);
    };
    /**
     * Add ignore patterns to .gitignore contents
     */
    addIgnorePatterns = async (patterns) => {
        if (patterns.length === 0) {
            // all patterns are already in .gitignore, noop
            return;
        }
        // Add EOL to end of each pattern, ensure additional content begins and ends with EOL
        const content = (patterns[0] === os.EOL || !this.gitIgnoreExists() ? '' : os.EOL) +
            patterns.join(os.EOL) +
            os.EOL;
        await this.fs.appendFile(this.gitIgnorePath, content);
    };
    /**
     * If .gitignore does not exist, this is a noop. Otherwise, get contents as an array
     */
    getGitIgnoreContent = async () => {
        if (!this.gitIgnoreExists()) {
            return;
        }
        return (await this.fs.readFile(this.gitIgnorePath, 'utf-8'))
            .split(os.EOL)
            .map((s) => {
            let result = s.trim();
            // Removes leading/trailing /
            if (result.startsWith('/')) {
                result = result.slice(1);
            }
            if (result.endsWith('/')) {
                result = result.slice(0, -1);
            }
            return result;
        });
    };
    /**
     * Check if a .gitignore file exists in projectRoot
     */
    gitIgnoreExists = () => {
        return this.existsSync(this.gitIgnorePath);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0aWdub3JlX2luaXRpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2dpdGlnbm9yZV9pbml0aWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxJQUFJLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQztBQUMvQyxPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFNWjtJQUNBO0lBQ0E7SUFQRixhQUFhLENBQVM7SUFDdkM7O09BRUc7SUFDSCxZQUNtQixXQUFtQixFQUNuQixhQUFhLFdBQVcsRUFDeEIsS0FBSyxHQUFHO1FBRlIsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFDbkIsZUFBVSxHQUFWLFVBQVUsQ0FBYztRQUN4QixPQUFFLEdBQUYsRUFBRSxDQUFNO1FBRXpCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFRDs7T0FFRztJQUNILGlCQUFpQixHQUFHLEtBQUssSUFBbUIsRUFBRTtRQUM1QyxNQUFNLGNBQWMsR0FBRztZQUNyQixXQUFXO1lBQ1gsY0FBYztZQUNkLFVBQVU7WUFDVixrQkFBa0I7WUFDbEIsdUJBQXVCO1NBQ3hCLENBQUM7UUFDRixNQUFNLGdCQUFnQixHQUFHLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFFMUQsNEVBQTRFO1FBQzVFLElBQUksZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNuRCxNQUFNLHNCQUFzQixHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQ2xELENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FDakQsQ0FBQztZQUVGLDBEQUEwRDtZQUMxRCxJQUNFLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3BDLHNCQUFzQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQ2pDO2dCQUNBLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDeEM7WUFFRCxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3JELE9BQU87U0FDUjtRQUVELE9BQU8sQ0FBQyxHQUFHLENBQ1QsMkVBQTJFLEVBQzNFLFFBQVEsQ0FBQyxLQUFLLENBQ2YsQ0FBQztRQUVGLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0ssaUJBQWlCLEdBQUcsS0FBSyxFQUFFLFFBQWtCLEVBQWlCLEVBQUU7UUFDdEUsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN6QiwrQ0FBK0M7WUFDL0MsT0FBTztTQUNSO1FBRUQscUZBQXFGO1FBQ3JGLE1BQU0sT0FBTyxHQUNYLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQztZQUNqRSxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDckIsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUVULE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN4RCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNLLG1CQUFtQixHQUFHLEtBQUssSUFBbUMsRUFBRTtRQUN0RSxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFO1lBQzNCLE9BQU87U0FDUjtRQUVELE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDekQsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUM7YUFDYixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNULElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUV0Qiw2QkFBNkI7WUFDN0IsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUMxQixNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxQjtZQUNELElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDeEIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDOUI7WUFFRCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0ssZUFBZSxHQUFHLEdBQVksRUFBRTtRQUN0QyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhpc3RzU3luYyBhcyBfZXhpc3RzU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCBfZnMgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcbmltcG9ydCB7IExvZ0xldmVsLCBwcmludGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcblxuLyoqXG4gKiBFbnN1cmUgdGhhdCB0aGUgLmdpdGlnbm9yZSBmaWxlIGV4aXN0cyB3aXRoIHRoZSBjb3JyZWN0IGNvbnRlbnRzIGluIHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5XG4gKi9cbmV4cG9ydCBjbGFzcyBHaXRJZ25vcmVJbml0aWFsaXplciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ2l0SWdub3JlUGF0aDogc3RyaW5nO1xuICAvKipcbiAgICogSW5qZWN0aW5nIGNvbnNvbGUgYW5kIGZzIGZvciB0ZXN0aW5nXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb2plY3RSb290OiBzdHJpbmcsXG4gICAgcHJpdmF0ZSByZWFkb25seSBleGlzdHNTeW5jID0gX2V4aXN0c1N5bmMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmcyA9IF9mc1xuICApIHtcbiAgICB0aGlzLmdpdElnbm9yZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5wcm9qZWN0Um9vdCwgJy5naXRpZ25vcmUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiAuZ2l0aWdub3JlIGV4aXN0cywgYXBwZW5kIHBhdHRlcm5zIHRvIGlnbm9yZS4gT3RoZXJ3aXNlLCBjcmVhdGUgLmdpdGlnbm9yZSB3aXRoIHBhdHRlcm5zIHRvIGlnbm9yZVxuICAgKi9cbiAgZW5zdXJlSW5pdGlhbGl6ZWQgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgaWdub3JlUGF0dGVybnMgPSBbXG4gICAgICAnIyBhbXBsaWZ5JyxcbiAgICAgICdub2RlX21vZHVsZXMnLFxuICAgICAgJy5hbXBsaWZ5JyxcbiAgICAgICdhbXBsaWZ5X291dHB1dHMqJyxcbiAgICAgICdhbXBsaWZ5Y29uZmlndXJhdGlvbionLFxuICAgIF07XG4gICAgY29uc3QgZ2l0SWdub3JlQ29udGVudCA9IGF3YWl0IHRoaXMuZ2V0R2l0SWdub3JlQ29udGVudCgpO1xuXG4gICAgLy8gSWYgLmdpdGlnbm9yZSBleGlzdHMsIGFwcGVuZCBpZ25vcmVQYXR0ZXJucyB0aGF0IGRvIG5vdCBleGlzdCBpbiBjb250ZW50c1xuICAgIGlmIChnaXRJZ25vcmVDb250ZW50ICYmIGdpdElnbm9yZUNvbnRlbnQubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgZmlsdGVyZWRJZ25vcmVQYXR0ZXJucyA9IGlnbm9yZVBhdHRlcm5zLmZpbHRlcihcbiAgICAgICAgKHBhdHRlcm4pID0+ICFnaXRJZ25vcmVDb250ZW50LmluY2x1ZGVzKHBhdHRlcm4pXG4gICAgICApO1xuXG4gICAgICAvLyBBZGQgb3MuRU9MIGlmIGxhc3QgbGluZSBvZiAuZ2l0aWdub3JlIGRvZXMgbm90IGhhdmUgRU9MXG4gICAgICBpZiAoXG4gICAgICAgIGdpdElnbm9yZUNvbnRlbnQuc2xpY2UoLTEpWzBdICE9PSAnJyAmJlxuICAgICAgICBmaWx0ZXJlZElnbm9yZVBhdHRlcm5zLmxlbmd0aCA+IDBcbiAgICAgICkge1xuICAgICAgICBmaWx0ZXJlZElnbm9yZVBhdHRlcm5zLnVuc2hpZnQob3MuRU9MKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5hZGRJZ25vcmVQYXR0ZXJucyhmaWx0ZXJlZElnbm9yZVBhdHRlcm5zKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwcmludGVyLmxvZyhcbiAgICAgICdObyAuZ2l0aWdub3JlIGZpbGUgZm91bmQgaW4gdGhlIHdvcmtpbmcgZGlyZWN0b3J5LiBDcmVhdGluZyAuZ2l0aWdub3JlLi4uJyxcbiAgICAgIExvZ0xldmVsLkRFQlVHXG4gICAgKTtcblxuICAgIGF3YWl0IHRoaXMuYWRkSWdub3JlUGF0dGVybnMoaWdub3JlUGF0dGVybnMpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGQgaWdub3JlIHBhdHRlcm5zIHRvIC5naXRpZ25vcmUgY29udGVudHNcbiAgICovXG4gIHByaXZhdGUgYWRkSWdub3JlUGF0dGVybnMgPSBhc3luYyAocGF0dGVybnM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgaWYgKHBhdHRlcm5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gYWxsIHBhdHRlcm5zIGFyZSBhbHJlYWR5IGluIC5naXRpZ25vcmUsIG5vb3BcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBBZGQgRU9MIHRvIGVuZCBvZiBlYWNoIHBhdHRlcm4sIGVuc3VyZSBhZGRpdGlvbmFsIGNvbnRlbnQgYmVnaW5zIGFuZCBlbmRzIHdpdGggRU9MXG4gICAgY29uc3QgY29udGVudCA9XG4gICAgICAocGF0dGVybnNbMF0gPT09IG9zLkVPTCB8fCAhdGhpcy5naXRJZ25vcmVFeGlzdHMoKSA/ICcnIDogb3MuRU9MKSArXG4gICAgICBwYXR0ZXJucy5qb2luKG9zLkVPTCkgK1xuICAgICAgb3MuRU9MO1xuXG4gICAgYXdhaXQgdGhpcy5mcy5hcHBlbmRGaWxlKHRoaXMuZ2l0SWdub3JlUGF0aCwgY29udGVudCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIElmIC5naXRpZ25vcmUgZG9lcyBub3QgZXhpc3QsIHRoaXMgaXMgYSBub29wLiBPdGhlcndpc2UsIGdldCBjb250ZW50cyBhcyBhbiBhcnJheVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRHaXRJZ25vcmVDb250ZW50ID0gYXN5bmMgKCk6IFByb21pc2U8c3RyaW5nW10gfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBpZiAoIXRoaXMuZ2l0SWdub3JlRXhpc3RzKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZnMucmVhZEZpbGUodGhpcy5naXRJZ25vcmVQYXRoLCAndXRmLTgnKSlcbiAgICAgIC5zcGxpdChvcy5FT0wpXG4gICAgICAubWFwKChzKSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQgPSBzLnRyaW0oKTtcblxuICAgICAgICAvLyBSZW1vdmVzIGxlYWRpbmcvdHJhaWxpbmcgL1xuICAgICAgICBpZiAocmVzdWx0LnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5zbGljZSgxKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0LmVuZHNXaXRoKCcvJykpIHtcbiAgICAgICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhIC5naXRpZ25vcmUgZmlsZSBleGlzdHMgaW4gcHJvamVjdFJvb3RcbiAgICovXG4gIHByaXZhdGUgZ2l0SWdub3JlRXhpc3RzID0gKCk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiB0aGlzLmV4aXN0c1N5bmModGhpcy5naXRJZ25vcmVQYXRoKTtcbiAgfTtcbn1cbiJdfQ==